# HTTP协议

## 什么是HTTP协议

HTTP协议(超文本传输协议)是浏览器与服务端之间最主要的通信协议

## HTTP0.9

协议定义了客户端发起请求、服务端响应请求的通信模式。最初只是用来传输文本的，以ASCII方式返回

## HTTP1.0

可以用来传输脚本，样式，图片，音频，视频等

最核心的点：增加了头部设定，头部内容以键值对的形式设置。请求头部通过Accept字段来告诉服务端可以接收的文件类型，响应头部通过Content

头部设定不仅解决了不同类型文件传输的问题，还有其他非常多的功能可以依靠头部字段，比如缓存和认证信息

http1.0中，每次发送请求的流程为，客户端发送请求，与服务端建立连接，传输数据，断开连接的过程

## HTTP1.1

HTTP1.0中的连接请求中，每次请求都会建立请求，发送数据，断开请求的过程，这样很耗费性能

而在HTTP1.1中增加了一个创建持久连接的方式。就是在传输结束时，并不是马上关闭，而是继续复用它传输其他的请求数据，连接会保存在浏览器或者服务器要求断开连接为止

### TCP建立/断开连接的方式

#### 三次握手

第一次握手让服务端知道客户端具有发送能力，第二次握手成功让客户端知道服务端具有接收和发送能力，此时服务端还不知道客户端能否接收自己的信息，第三次握手就是让服务端知道客户端能够收到自己的信息

1. 客户端处于close状态，服务端处于listen状态。客户端发送一个SYN报文+ISN
2. 服务端收到SYN报文，会以自己的 SYN 报文作为应答，并且也指定了自己的初始化序列号 ISN。同时会把客户端的 ISN + 1 作为 ACK 的值，表示自己已经收到了客户端的 SYN，此时服务器处于 SYN_REVD 的状态
3. 当客户端收到 SYN 报文之后，会发送一个 ACK 报文，当然，也同样把服务器的 ISN + 1 作为 ACK 的值，表示已经收到了服务端的 SYN 报文，此时客户端处于 ESTABLISHED 状态。服务器收到 ACK 报文之后，也处于 ESTABLISHED 状态，此时，双方成功建立起了连接

<img src='https://s0.lgstatic.com/i/image/M00/2E/A9/Ciqc1F8FfwaAMcTJAAEFwffjRvg679.png' width='500' />

#### 四次挥手

1. 客户端发送FIN报文，和服务器说我要关闭数据传输了
2. 服务端收到FIN报文，向客户端发送ACK报文，表示我收到你的报文了
3. 如果服务端同意关闭连接了，想客户端发送FIN报文，表示我也同意关闭连接了
4. 客户端收到ACK后，并且收到了服务端的FIN后，像服务端发送一个ACK报文，服务端收到ACK后，改变自身状态，此时连接关闭

<img src='https://s0.lgstatic.com/i/image/M00/2E/AA/Ciqc1F8Ffy6AEYs9AAD7_LezsQ8385.png' width='500' />

## HTTP2

HTTP1.1解决的问题：通过长连接减少大量创建/断开连接的请求造成的性能消耗，但是由于并发能力收到限制，传性能还是有很大的提升空间

### HTTP1.1的并发能力问题

- 浏览器为了减轻服务器压力，限制同一个域名的HTTP连接数为6-8个
- HTTP/1.1 本身的问题，虽然 HTTP/1.1 中使用持久连接时，多个请求能共用一个 TCP 连接，但在一个连接中同一时刻只能处理一个请求，在当前的请求没有结束之前，其他的请求只能处于阻塞状态，这种情况被称为 “队头阻塞”

HTTP2不在使用ASCII编码传输，而是使用二进制传数据。客户端在发送请求时会将每个请求的内容封装成不同的带有编号的二进制帧，然后将这些帧同时发送给服务端。服务端接收到数据之后，会将相同编号的帧合并为完整的请求信息。同样，服务端返回结果、客户端接收结果也遵循这个帧的拆分与组合的过程

受益于二进制分帧，对于同一个域，客户端只需要与服务端建立一个连接即可完成通信需求，自然也不再受限于浏览器的连接数限制了，这种利用一个连接来发送多个请求的方式称为“多路复用”

HTTP/2 也增加了一些其他的功能，比如通过压缩头部信息来减少传输体积，以及通过服务推送来减少客户端请求